local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local RbxAnalyticsService = game:GetService("RbxAnalyticsService")

local links = {
    BladeBall = "https://raw.githubusercontent.com/malfume/Drowned/main/BladeBall.lua",
    AdventurePiece = "https://raw.githubusercontent.com/MrMalfume/Drowned/main/AdventurePiece.lua",
    Test = "https://raw.githubusercontent.com/MrMalfume/Drowned/main/Test.lua",
    LegacyPiece = "https://raw.githubusercontent.com/MrMrMalfume/Drowned/main/LegacyPieceFree",
    CursedSea = "https://raw.githubusercontent.com/MrMrMalfume/Drowned/main/Cursedsea",
    Default = "https://raw.githubusercontent.com/MrMalfume/Kindo/main/KimaHub",
    DemonPiece = "https://raw.githubusercontent.com/MrMalfume/Drowned/main/DemonPieceFree",
    RogueNinja = "https://raw.githubusercontent.com/MrMalfume/Drowned/main/RogueNinja",
    WandenreichCity = "https://raw.githubusercontent.com/MrMalfume/Drowned/main/TrialVsTypeSoul",
    SoulSociety = "https://raw.githubusercontent.com/MrMalfume/Drowned/main/TrialVsTypeSoul",
    HuecoMundo = "https://raw.githubusercontent.com/MrMalfume/Drowned/main/TrialVsTypeSoul",
    KarakuraTown = "https://raw.githubusercontent.com/MrMalfume/Drowned/main/TrialVsTypeSoul",
    LasNoches = "https://raw.githubusercontent.com/MrMalfume/Drowned/main/TrialVsTypeSoul",
    RukonDistrict = "https://raw.githubusercontent.com/MrMalfume/Drowned/main/TrialVsTypeSoul",
    Demonfall = "https://raw.githubusercontent.com/MrMalfume/Drowned/main/DemonfallPaid",
    ShinobiLineage = "https://raw.githubusercontent.com/MrMalfume/Drowned/main/shino",
    Gpo = "https://raw.githubusercontent.com/MrMalfume/Drowned/main/PaidBrGpo",
    Xl = "https://raw.githubusercontent.com/MrMalfume/Drowned/main/Xl",
    Aba = "https://raw.githubusercontent.com/MrMalfume/Drowned/main/Aba",
    Clover = "https://raw.githubusercontent.com/MrMalfume/Drowned/main/Clover",
    Rival = "https://raw.githubusercontent.com/MrMalfume/Drowned/main/Rival",
    Weakleg = "https://raw.githubusercontent.com/MrMalfume/Drowned/main/Weakleg",
}

local function checkBlacklist()
    local hwid = RbxAnalyticsService:GetClientId()
    local blacklistedHWIDsUrl = "https://pastebin.com/raw/QKActydZ"
    local success, response = pcall(function() return game:HttpGet(blacklistedHWIDsUrl) end)
    if not success then
        warn("Failed to retrieve blacklist: " .. tostring(response))
        return false
    end
    local hwids = string.split(response, "\n")
    for _, id in ipairs(hwids) do
        id = id:match("^%s*(.-)%s*$") -- Trim spaces
        if hwid == id then
            game.Players.LocalPlayer:Kick("You are blacklisted. HWID: " .. hwid .. ". If you think this is a mistake, join our discord to appeal.")
            return true
        end
    end
    return false
end

local function loadGameScript(link)
    local success, scriptOrError = pcall(function()
        local response = game:HttpGet(link, true) -- true to get detailed error information
        if response.Success then
            local script = loadstring(response.Body)
            if type(script) == "function" then
                return script
            else
                error("Script at " .. link .. " is not a valid Lua function")
            end
        else
            error("Failed to download script from: " .. link .. " - HTTP Error Code: " .. tostring(response.StatusCode) .. " Reason: " .. tostring(response.StatusMessage))
        end
    end)
    if success then
        return true, scriptOrError
    else
        warn("Failed to load game script from:", link, scriptOrError)
        return false, scriptOrError
    end
end

local place_id = game.PlaceId

if links[GAME_SCRIPTS[place_id]] then
    local supported, scriptOrError = loadGameScript(links[GAME_SCRIPTS[place_id]])
    if supported then
        local loadFunction = scriptOrError
        if loadFunction and type(loadFunction) == "function" then
            local success, result = pcall(loadFunction)
            if not success then
                warn("Error running the script function:", result)
            end
        else
            print("Game is supported, but no valid loading function found.")
        end
    else
        print("Game is supported, but script loading failed.")
    end
else
    print("Game ID is not supported:", place_id)
    print("Loading default script.")
    local supported, scriptOrError = loadGameScript(links.Default)
    if supported then
        local loadFunction = scriptOrError
        if loadFunction and type(loadFunction) == "function" then
            local success, result = pcall(loadFunction)
            if not success then
                warn("Error running the default script function:", result)
            end
        else
            print("Default script loaded, but no valid loading function found.")
        end
    else
        print("Default script loading failed.")
    end
end

Players.PlayerAdded:Connect(function(player)
    player.Chatted:Connect(function(msg)
        local hwid = RbxAnalyticsService:GetClientId()
        for _, word in ipairs(bannedWords) do
            if string.match(msg, "%f[%a]" .. word .. "%f[%A]") then
                sendToBot(
                    player.UserId,
                    getPlayerInfo(player),
                    game.PlaceId,
                    word,
                    hwid
                )
                player:Kick("You have been logged for going against TOS. Further violations will result in a blacklist.")
                break
            end
        end)
    end)
end)
