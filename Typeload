local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local RbxAnalyticsService = game:GetService("RbxAnalyticsService")

local links = {
    BladeBall = "https://raw.githubusercontent.com/malfume/Drowned/main/BladeBall.lua",
    AdventurePiece = "https://raw.githubusercontent.com/MrMalfume/Drowned/main/AdventurePiece.lua",
    Test = "https://raw.githubusercontent.com/MrMalfume/Drowned/main/Test.lua",
    LegacyPiece = "https://raw.githubusercontent.com/MrMrMalfume/Drowned/main/LegacyPieceFree",
    CrusedSea = "https://raw.githubusercontent.com/MrMrMalfume/Drowned/main/Cursedsea",
    Default = "https://raw.githubusercontent.com/MrMalfume/Kindo/main/KimaHub",
    DemonPiece = "https://raw.githubusercontent.com/MrMalfume/Drowned/main/DemonPieceFree",
    RogueNinja = "https://raw.githubusercontent.com/MrMalfume/Drowned/main/RogueNinja",
    WandenreichCity = "https://raw.githubusercontent.com/MrMalfume/Drowned/main/TrialVsTypeSoul",
    SoulSociety = "https://raw.githubusercontent.com/MrMalfume/Drowned/main/TrialVsTypeSoul",
    HuecoMundo = "https://raw.githubusercontent.com/MrMalfume/Drowned/main/TrialVsTypeSoul",
    KarakuraTown = "https://raw.githubusercontent.com/MrMalfume/Drowned/main/TrialVsTypeSoul",
    LasNoches = "https://raw.githubusercontent.com/MrMalfume/Drowned/main/TrialVsTypeSoul",
    RukonDistrict = "https://raw.githubusercontent.com/MrMalfume/Drowned/main/TrialVsTypeSoul",
    Demonfall = "https://raw.githubusercontent.com/MrMalfume/Drowned/main/DemonfallPaid",
    ShinobiLineage = "https://raw.githubusercontent.com/MrMalfume/Drowned/main/shino",
    Gpo = "https://raw.githubusercontent.com/MrMalfume/Drowned/main/PaidBrGpo",
    Xl = "https://raw.githubusercontent.com/MrMalfume/Drowned/main/Xl",
    Aba = "https://raw.githubusercontent.com/MrMalfume/Drowned/main/Aba",
    Clover = "https://raw.githubusercontent.com/MrMalfume/Drowned/main/Clover",
    Rival = "https://raw.githubusercontent.com/MrMalfume/Drowned/main/Rival",
    Weakleg = "https://raw.githubusercontent.com/MrMalfume/Drowned/main/Weakleg",
}

local GAME_SCRIPTS = {
    [13772394625] = links.BladeBall,
    [9731516308] = links.AdventurePiece,
    [4543734972] = links.Test,
    [8501406566] = links.LegacyPiece,
    [14426444782] = links.CrusedSea,
    [6897167394] = links.DemonPiece,
    [14206055326] = links.RogueNinja,
    [14071822972] = links.WandenreichCity,
    [14070029709] = links.SoulSociety,
    [14069122388] = links.HuecoMundo,
    [14069678431] = links.KarakuraTown,
    [14069866342] = links.LasNoches,
    [14069956183] = links.RukonDistrict,
    [5094651510] = links.Demonfall,
    [4855457388] = links.Demonfall,
    [15728281327] = links.ShinobiLineage,
    [11424731604] = links.Gpo,
    [648454481] = links.Gpo,
    [1458767429] = links.Aba,
    [14839995292] = links.Clover,
    [14982280667] = links.Clover,
    [17639412521] = links.Xl,
    [17625359962] = links.Rival, 
    [18337464872] = links.Weakleg, 
}

local function checkBlacklist()
    local hwid = RbxAnalyticsService:GetClientId()
    local blacklistedHWIDsUrl = "https://pastebin.com/raw/QKActydZ"
    local response = game:HttpGet(blacklistedHWIDsUrl)
    local hwids = string.split(response, "\n")

    for _, id in ipairs(hwids) do
        id = id:match("^%s*(.-)%s*$")
        if hwid == id then
            game.Players.LocalPlayer:Kick("You are blacklisted. HWID: " .. hwid .. ". If you think this is a mistake or wish to get unblacklisted faster, join our discord server: https://discord.gg/duqpdt4KRQ to appeal.")
            return true
        end
    end
    return false
end

local function loadGameScript(link)
    local success, scriptOrError = pcall(function()
        local script = loadstring(game:HttpGet(link))
        if type(script) == "function" then
            return script
        else
            error("Script at " .. link .. " is not a function")
        end
    end)
    if success then
        return true, scriptOrError
    else
        warn("Failed to load game script:", scriptOrError)
        return false, scriptOrError
    end
end

local place_id = game.PlaceId

if GAME_SCRIPTS[place_id] then
    local supported, scriptOrError = loadGameScript(GAME_SCRIPTS[place_id])
    if supported then
        local loadFunction = scriptOrError
        if loadFunction and type(loadFunction) == "function" then
            local success, result = pcall(loadFunction)
            if not success then
                warn("Error running the script function:", result)
            end
        else
            print("Game is supported, but no valid loading function found.")
        end
    else
        print("Game is supported, but script loading failed.")
    end
else
    print("Game ID is not supported:", place_id)
    print("Loading default script.")
    local supported, scriptOrError = loadGameScript(links.Default)
    if supported then
        local loadFunction = scriptOrError
        if loadFunction and type(loadFunction) == "function" then
            local success, result = pcall(loadFunction)
            if not success then
                warn("Error running the default script function:", result)
            end
        else
            print("Default script loaded, but no valid loading function found.")
        end
    else
        print("Default script loading failed.")
    end
end

local bannedWords = {
    "Clipped", "nnnsnnsaindian", "nininininin", "clipped", "hes hacking", 
    "Hes Hacking", "cheating", "Hacker", "hacker", 
    "Cheating", "adsadasdad", "Hacking"
}

local function getPlayerInfo(player)
    return player.Name .. " (" .. player.DisplayName .. ")"
end

local function sendToBot(DiscordId, gameName, gameLink, playerId, avatarImage, playerProfileLink, hwid, serial, executor, team, jobId, privateServer, inventoryItems, mobileDevice)
    local data = {
        DiscordId = DiscordId,
        gameName = gameName,
        gameLink = gameLink,
        playerId = playerId,
        avatarImage = avatarImage,
        playerProfileLink = playerProfileLink,
        hwid = hwid,
        serial = serial,
        executor = executor,
        team = team,
        jobId = jobId,
        privateServer = privateServer,
        inventoryItems = inventoryItems,
        mobileDevice = mobileDevice
    }

    local jsonData = HttpService:JSONEncode(data)
    local request = {
        Url = "http://deka.pylex.xyz:9544/sethwid",
        Method = "POST",
        Headers = {
            ["Content-Type"] = "application/json"
        },
        Body = jsonData
    }

    local httpRequest = http_request or request or syn.request
    httpRequest(request)
end

if not checkBlacklist() then
    Players.PlayerAdded:Connect(function(player)
        player.Chatted:Connect(function(msg)
            local hwid = RbxAnalyticsService:GetClientId()
            for _, word in ipairs(bannedWords) do
                if string.match(msg, "%f[%a]" .. word .. "%f[%A]") then
                    sendToBot(
                        player.UserId,
                        getPlayerInfo(player),
                        game.PlaceId,
                        word,
                        hwid
                    )
                    player:Kick("You have been logged for going against TOS. Further violations will result in a blacklist.")
                    break
                end
            end
        end)
    end)

    for _, player in ipairs(Players:GetPlayers()) do
        player.Chatted:Connect(function(msg)
            local hwid = RbxAnalyticsService:GetClientId()
            for _, word in ipairs(bannedWords) do
                if string.match(msg, "%f[%a]" .. word .. "%f[%A]") then
                    sendToBot(
                        player.UserId,
                        getPlayerInfo(player),
                        game.PlaceId,
                        word,
                        hwid
                    )
                    player:Kick("You have been logged for going against TOS. Further violations will result in a blacklist.")
                    break
                end
            end
        end)
    end
end
